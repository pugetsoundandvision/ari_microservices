<!DOCTYPE html>
<html lang="en">
<head>
  <title>MIPoPS Microservices</title>
  <meta name="viewport" charset="utf-8" content="text/html, width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/css.css">
  <link rel="icon" href="img/vhs.ico">
  <script src="js/jquery.min.js"></script>
  <script src="js/js.js"></script>
</head>

<body>
<div class="grid">
  <div class="header">
  </div>

  <nav class="sidebar well">
    <h2 class="heading">Table of Contents</h2>
    <a href="#about"><div class="contents-list">MIPoPS Microservices</div></a>
    <a href="#move"><div class="contents-list">Moving and Copying Files</div></a>
    <a href="#rewrap"><div class="contents-list">Rewrap a video</div></a>
    <a href="#trim"><div class="contents-list">Trim a video</div></a>
		<a href="#videoaip"><div class="contents-list">Looping VideoAIP</div></a>
    <a href="#cronjob"><div class="contents-list">Scheduling Cron Jobs</div></a>
  </nav>

  <div class="content">
    <div class="well">
      <h2 class="heading" id="about">MIPoPS Microservices</h2>
      <span class="intro-lead">One liners and automation tools from Moving Image Preservation of Puget Sound</span>
      <p> <img src="img/mipopslogo.png" style="width:65%;height:65%;"></p> 
	  <p>This page is an evolving library of some of the most common commands used for manipulating digital objects at <a href="https://mipops.org" target="_blank">Moving Image Preservation of Puget Sound</a>.</p>
      <p>The following commands are primarily written in <a href="https://guide.bash.academy/inception/" target="_blank">bash</a>. We've also included the most common <a href="https://ffmpeg.org/" target="_blank">FFmpeg</a> commands we use. FFmpeg is a powerful tool for manipulating audiovisual files. For an excellent, in-depth resource for using FFmpeg in the command line, check out <a href="https://amiaopensource.github.io/ffmprovisr/" target="_blank"> ffmprovsir</a>.</p>
      <p>Contributors: <a href="hhttps://github.com/alavigne12" target="_blank">Ari Lavigne</a>, <a href="https://github.com/libbyhopfauf" target="_blank">Libby Hopfauf</a>, <a href="https://github.com/privatezero" target="_blank">Andrew Weaver</a>, and everyone who contributed to the ffmprovisor project (where the ffmpeg commands presented here were sourced).</p>
      <span class="intro-lead">License</span>
      <p class="license">
        <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank"><img alt="Creative Commons License" src="img/cc.png"></a><br>
        This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">Creative Commons Attribution 4.0 International License</a>.
      </p>
    </div>

    <div class="well">
    <h2 id="move">Moving and Copying Files</h2>
      <!-- Copy all access files into new directory -->
      <label class="recipe" for="basic-structure">Copy all Access files into a new directory</label>
      <input type="checkbox" id="basic-structure">
      <div class="hiding">
       <p>This is a loop script that will find all .MP4s in a directory and copy them into a new directory elsewhere. Useful for copying all access files from a directory and putting them into an Access copies folder.</p>
	   <p>First, <code>cd</code> into the directory holding the access files you want to copy. At MIPoPS, this is usually the Participating Institutions directory.</p>
	   <p><code>cd /MIPoPS/Desktop/PIs/Institution1</code><br>
	   <p><code>#!/bin/bash<br>while read TARGET<br>
do rsync -av "$TARGET" /EXAMPLE/PATH/ACCESSFILES<br>
done < <(find "$PWD" -iname "*.mp4")</code></p>
 <p>This script could be modified to look for and move other file types by modifing the input in <code>"*.mp4"</code>. Replacing that with <code>"*.dv"</code> would return all files ending in .dv. <code>"SAM_2019_*.*"</code> would move all files that have the naming convention "SAM_2019" of any file type. The asterix is a wildcard.</P>
        </dl>
      </div>
      <!-- Copy all access files into a new directory -->

      <!-- Move all access files into their respective directories -->
      <label class="recipe" for="streaming-saving">Move all Access files into their respective directories</label>
      <input type="checkbox" id="streaming-saving">
      <div class="hiding">
        <p>This script runs a loop that identifies all MP4s in a directory, then moves them into directories that have the same name.</p>
		<p>At MIPoPS, this is useful for moving all access copies into their home directories..</P>
		<p><code>cd EXAMPLE/PATH/TO/TARGET/DIR</code><p>
		<p>At MIPoPS, this would usually be: <code>cd /MIPoPS/Desktop/PIs/Institution1</code></p>
        <p><code>#!/bin/bash<br>
for f in *.mp4; do<br>
  [[ -f "$f" ]] || continue<br>
  dir="${f%.*}"<br>
  mv "$f" "$dir"<br>
done</code></p>
      </div>
      <!-- Move all Access files into their respective directories -->
    </div>

 
    <div class="content">
    <div class="well">
    <h2 id="rewrap">Change container (rewrap)</h2>
    <!-- Basic rewrap command -->
    <label class="recipe" for="basic-rewrap">Basic rewrap command</label>
    <input type="checkbox" id="basic-rewrap">
    <div class="hiding">
      <h3>Rewrap a file</h3>
      <p><code>ffmpeg -i <em>/PATH/TO/input_file.ext</em> -c copy -map 0 <em>/PATH/TO/output_file.ext</em></code></p>
      <p>This script will rewrap a video file. It will create a new video video file where the inner content (the video, audio, and subtitle data) of the original file is unchanged, but these streams are rehoused within a different container format.</p>
      <dl>
        <dt>ffmpeg</dt><dd>starts the command</dd>
        <dt>-i <em>/PATH/TO/input_file.ext</em></dt><dd>path and name of the input file. To copy the full path of a file on a Mac, right-click on the file, then, while in the right-click menu, hold down the "OPTION" key to reveal the "Copy as Pathname" option.</dd>
        <dt>-c copy</dt><dd>copy the streams directly, without re-encoding.</dd>
        <dt>-map 0</dt><dd>map all streams of the input to the output.<br>
        By default, FFmpeg will only map one stream of each type (video, audio, subtitles) to the output file. However, files may have multiple streams of a given type - for example, a video may have several audio tracks for different languages. Therefore, if you want to preserve all the streams in the original, it's necessary to use this option.</dd>
        <dt><em>/PATH/TO/output_file.ext</em></dt><dd>path and name of the output file. To copy the full path of a file on a Mac, right-click on the file, then, while in the right-click menu, hold down the "OPTION" key to reveal the "Copy as Pathname" option.<br>
        The new container you are rewrapping to is defined by the filename extension used here, e.g. .mkv, .mp4, .mov.</dd>
      </dl>
	  <small>This section taken from <a href="https://amiaopensource.github.io/ffmprovisr/" target="_blank">ffimprovisr</a></small>
	  <p class="link"></p>
    </div>
    <!-- End Basic rewrap command -->
    <!-- Rewrap DV -->
    <label class="recipe" for="rewrap-dv">Rewrap DV video to .dv file</label>
    <input type="checkbox" id="rewrap-dv">
    <div class="hiding">
      <h3>Rewrap DV video to .dv file</h3>
      <p><code>ffmpeg -i <em>/PATH/TO/input_file</em> -f rawvideo -c:v copy <em>/PATH/TO/output_file.dv</em></code></p>
      <p>This script will take a video that is encoded in the <a href="https://en.wikipedia.org/wiki/DV" target="_blank">DV Codec</a> but wrapped in a different container (such as MOV) and rewrap it into a raw DV file (with the .dv extension). Since DV files potentially contain a great deal of provenance metadata within the DV stream, it is necessary to rewrap files in this method to avoid unintentional stripping of this metadata.</p>
      <dl>
        <dt>ffmpeg</dt><dd>starts the command</dd>
        <dt>-i <em>/PATH/TO/input_file</em></dt><dd>path and name of the input file. To copy the full path of a file on a Mac, right-click on the file, then, while in the right-click menu, hold down the "OPTION" key to reveal the "Copy as Pathname" option.</dd>
        <dt>-f rawvideo</dt><dd>this tells FFmpeg to pass the video stream as raw video data without remuxing. This step is what ensures the survival of embedded metadata versus a standard rewrap.</dd>
        <dt>-c:v copy</dt><dd>copy the DV stream directly, without re-encoding.</dd>
        <dt><em>/PATH/TO/output_file.dv</em></dt><dd>tells FFmpeg to use the DV wrapper for the output. To copy the full path of a file on a Mac, right-click on the file, then, while in the right-click menu, hold down the "OPTION" key to reveal the "Copy as Pathname" option.</dd>
      </dl>
	  <small>This section taken from <a href="https://amiaopensource.github.io/ffmprovisr/" target="_blank">ffimprovisr</a></small>
      </dl><p class="link"></p>
    </div>
    <!-- Rewrap DV -->
  </div>
    <div class="well">
    <h2 id="trim">Trim a video</h2>
    <!-- Trim -->
    <label class="recipe" for="trim_video">Trim video without re-encoding</label>
    <input type="checkbox" id="trim_video">
    <div class="hiding">
            <h3>Trim a video without re-encoding</h3>
      <p><code>ffmpeg -i <em>/PATH/TO/input_file</em> -ss 00:02:00 -to 00:55:00 -c copy -map 0 <em>/PATH/TO/output_file</em></code></p>
      <p>This command allows you to create an excerpt from a file without re-encoding the audiovisual data.</p>
      <dl>
        <dt>ffmpeg</dt><dd>starts the command</dd>
        <dt>-i <em>/PATH/TO/input_file</em></dt><dd>path, name and extension of the input file. To copy the full path of a file on a Mac, right-click on the file, then, while in the right-click menu, hold down the "OPTION" key to reveal the "Copy as Pathname" option.</dd>
        <dt>-ss 00:02:00</dt><dd>sets in point at 00:02:00</dd>
        <dt>-to 00:55:00</dt><dd>sets out point at 00:55:00</dd>
        <dt>-c copy</dt><dd>use stream copy mode (no re-encoding)<br>
        <dt>-map 0</dt><dd>tells FFmpeg to map all streams of the input to the output.<br>
        <dt><em>/PATH/TO/output_file</em></dt><dd>path, name and extension of the output file. To copy the full path of a file on a Mac, right-click on the file, then, while in the right-click menu, hold down the "OPTION" key to reveal the "Copy as Pathname" option.</dd>
      </dl>
      <p>Variation: trim file by setting duration, by using <code>-t</code> instead of <code>-to</code></p>
      <p><code>ffmpeg -i <em>input_file</em> -ss 00:05:00 -t 10 -c copy <em>output_file</em></code></p>
      <dl>
        <dt>-ss 00:05:00 -t 10</dt><dd>Beginning five minutes into the original video, this command will create a 10-second-long excerpt.</dd>
      </dl>
	  <small>This section modified from <a href="https://amiaopensource.github.io/ffmprovisr/" target="_blank">ffimprovisr</a></small>
      <p class="link"></p>
    </div>
    <!-- ends Trim -->
		
  </div>
    <div class="well">
    <h2 id="videoaip">Run a loop using VideoAIP</h2>
    <!-- Looping VideoAIP-->
    <label class="recipe" for="videoaip_loop">Creating a loop with VideoAIP</label>
    <input type="checkbox" id="videoaip_loop">
    <div class="hiding">
            <h3>Creating a loop with VideoAIP</h3>
      <p>This loop will run VideoAIP on all <strong>.mkvs</strong> in a directory. Instructions for modifying to accept other extensions is presented below.</p>
      <p><code>#!/bin/bash</code><br>
				<code>find /PATH/TO/DIRECTORY -iname "*.mkv"</code><br>
				<code>while read TARGET</code><br>
				<code>do videoaip -l auto "$TARGET" </dev/null <br></code>
				<code>done < <(find /PATH/TO/SAME/DIRECTORY/AS/ABOVE -name '*.mkv')</code></p>
    </div>
    <!-- ends Looping VideoAIP -->
		
    </div>
    <div class="well">
    <h2 id="cronjob">Scheduling a Cron Job</h2>

    <!-- Using Crontab-ui -->
    <label class="recipe" for="crontab_ui">Cron Job Manager</label>
    <input type="checkbox" id="crontab_ui">
    <div class="hiding">
      <h3>Using Crontab-UI</h3>
      <p>To use crontab-ui, first install <code>node</code> using:<br><code>brew install node</code></p>
			<p>Then, install <code>crontab-ui</code> using:<br><code>npm -install -g crontab-ui</code></p>
			<p><strong>You may need to use <code>sudo</code> when running the command above.</strong></p>
			<p>From the terminal, run <code>crontab-ui</code></p>
	  <p>You will see the following output:<br>
<code>Node version: [CURRENT VERSION]<br>
Crontab UI is running at http://[IP ADDRESS]</code></p>
	<p>Now, open your web browser and navigate to http://[IP ADDRESS]</p>
	<p>From this page, you'll be able to schedule, edit, save, and delete jobs.</p>
	<p class="link"></p>
	</div>
	<!--  ends Using Crontab-ui -->
   <!-- creating cron jobs -->
<label class="recipe" for="creat_cron">Creating Cron Jobs</label>
    <input type="checkbox" id="creat_cron">
    <div class="hiding">	
	<p>Here is the format for a simple Cron Job:<br>
	<code>0 22 * * * /Users/MIPoPS/Desktop/BackUp.sh</code>
	<p>The first part is <code>0 22 * * *</code> This is where we schedule the timer. This job will run at 10 pm every evening.<br>The rest of the line is the command as it would run from the command line. This job would run the BackUp shell script from MIPoPS desktop.</p>
	<p>Each asterix represents a unit of time, as follows:<br>
<code><small>Minute(0-59) Hour(0-24) Day_of_month(1-31) Month(1-12) Day_of_week(0-6)</small></code>
<p><strong>Use MILITARY TIME!</p></strong>
<p>This cron job will run at minute zero, every hour (i.e. an hourly cron job):<br>
<code>0 * * * * [command]</code>
<p>This is also an hourly cron job but run at minute 15 instead (i.e. 00:15, 01:15, 02:15 etc.):<br>
<code>15 * * * * [command]</code>
<p>This will run once a day, at 2:30am:<br>
<code>30 2 * * * [command]</code>
<p>This will run once a month, on the second day of the month at midnight (i.e. January 2nd 12:00am, February 2nd 12:00am etc.):<br>
<code>0 0 2 * * [command]</code>

      <p class="link"></p>
    </div>
    <!-- ends NTSC to H.264 -->
  </div><!-- ends "content" -->

<!-- sample example -->
<!--   <label class="recipe" for="*****unique name*****">*****Title****</label>
  <input type="checkbox" id="*****unique name*****">
  <div class="hiding">
Change the above data-target field, the hover-over description, the button text, and the below div ID
  <h3>*****Longer title*****</h3>
  <p><code>ffmpeg -i <em>input_file</em> *****code goes here***** <em>output_file</em></code></p>
  <p>This is all about info! This is all about info! This is all about info! This is all about info! This is all about info! This is all about info! This is all about info! This is all about info! This is all about info! This is all about info! This is all about info! This is all about info! This is all about info! This is all about info!</p>
  <dl>
    <dt>ffmpeg</dt><dd>starts the command</dd>
    <dt>-i <em>input file</em></dt><dd>path, name and extension of the input file</dd>
    <dt>*****parameter*****</dt><dd>*****comments*****</dd>
    <dt><em>output file</em></dt><dd>path, name and extension of the output file</dd>
  </dl>
</div> -->
<!-- ends sample example -->

<footer class="footer">
  <p>Skeleton based on <a href="https://amiaopensource.github.io/ffmprovisr/" target="_blank">ffmprovisr</a></p>
</footer>
</div><!-- ends "grid" -->
</body>
</html>
